timeouts:
  job:
    minutes: 30
  connection:
    minutes: 2
  action:
    minutes: 2
context:
  test_character_delay: 10
  lava_test_results_dir: "/home/fio/lava-%s"
device_type: {{ device_type }}
job_name: OTA kernel rollback from {{ target }}
priority: 50
visibility: public
metadata:
  build-url: '{{ build_url }}'
  build-id: '{{ build_id }}'
  trigger: '{{ trigger }}'
actions:
{% include "deploy.inc.yaml" %}
    namespace: before
{% include "deploy2.inc.yaml" %}
    namespace: before
- command:
    namespace: before
    name: network_turn_on
- boot:
    namespace: before
{% include "boot.inc.yaml" %}
- test:
    namespace: before
    timeout:
      minutes: 10
    definitions:
    - repository: http://github.com/linaro/test-definitions.git
      from: git
      path: automated/linux/ota-rollback/download-update.yaml
      name: prepare-kernel-upgrade
- test:
    namespace: before
    timeout:
      minutes: 1
    interactive:
    - name: kernel-poweroff
      prompts: []
      script:
      - command: poweroff
        name: poweroff
        wait_for_prompt: False
        successes:
        - message: "Powering off"
- deploy:
    namespace: after
    connection-namespace: before
    timeout:
      minutes: 10
    to: downloads
    images:
      bootloader:
        url: {{ BOOTLOADER_URL }}
        headers:
          OSF-TOKEN: OSF-TOKEN
- boot:
    namespace: after
    connection-namespace: before
{% include "boot.inc.yaml" %}
- test:
    namespace: after
    connection-namespace: before
    timeout:
      minutes: 5
    definitions:
    - repository: http://github.com/linaro/test-definitions.git
      from: git
      path: automated/linux/ota-rollback/verify-rollback.yaml
      name: verify-kernel-rollback
- test:
    namespace: after
    connection-namespace: before
    timeout:
      minutes: 1
    interactive:
    - name: kernel-poweroff-after
      prompts: []
      script:
      - command: poweroff
        name: poweroff-after
        wait_for_prompt: False
        successes:
        - message: "Powering off"
- boot:
    namespace: after
    connection-namespace: before
{% include "boot.inc.yaml" %}
- test:
    namespace: after
    connection-namespace: before
    timeout:
      minutes: 5
    definitions:
    - repository: http://github.com/linaro/test-definitions.git
      from: git
      path: automated/linux/ota-rollback/verify-reboot.yaml
      name: verify-kernel-reboot
